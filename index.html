require('dotenv').config();
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const bodyParser = require("body-parser");

const app = express();
app.use(cors());
app.use(bodyParser.json());

// Connect MongoDB
mongoose.connect(process.env.MONGO_URI)
.then(()=>console.log("MongoDB connected"))
.catch(err=>console.log(err));

// Schemas
const userSchema = new mongoose.Schema({
    phone: String,
    name: String
});
const User = mongoose.model("User", userSchema);

const adminSchema = new mongoose.Schema({
    userId: mongoose.Schema.Types.ObjectId,
    shopName: String,
    phoneNumber: String, // for WhatsApp
    customerIds: [mongoose.Schema.Types.ObjectId]
});
const Admin = mongoose.model("Admin", adminSchema);

const itemSchema = new mongoose.Schema({
    adminId: mongoose.Schema.Types.ObjectId,
    పేరు: String,
    బరువు: String,
    బ్యాగులు: Number,
    ధర: Number,
    get మొత్తం(){ return this.బ్యాగులు * this.ధర; }
});
const Item = mongoose.model("Item", itemSchema);

// ===== Routes =====

// Signup
app.post("/signup", async (req,res)=>{
    const { phone, name } = req.body;
    let user = await User.findOne({ phone });
    if(!user){
        user = new User({ phone, name });
        await user.save();
    }
    res.json({ user });
});

// Login
app.post("/login", async (req,res)=>{
    const { phone } = req.body;
    let user = await User.findOne({ phone });
    if(!user) return res.status(404).json({msg:"User not found"});
    let admin = await Admin.findOne({ userId: user._id });
    res.json({ user, admin });
});

// All Users (for admin to pick customers)
app.get("/allUsers", async (req,res)=>{
    const users = await User.find();
    res.json(users);
});

// Create Shop / Admin
app.post("/admin/create", async (req,res)=>{
    const { userId, shopName } = req.body;
    let admin = new Admin({ userId, shopName, customerIds: [], phoneNumber: "" });
    await admin.save();
    res.json({ admin });
});

// Add Customer to Admin
app.post("/admin/addCustomer", async (req,res)=>{
    const { adminId, userId } = req.body;
    let admin = await Admin.findById(adminId);
    if(!admin.customerIds.includes(userId)) admin.customerIds.push(userId);
    await admin.save();
    res.json({ msg:"Customer added" });
});

// Add Item
app.post("/items/:adminId", async (req,res)=>{
    const { name, weight, bags, price } = req.body;
    const adminId = req.params.adminId;
    const item = new Item({ adminId, పేరు:name, బరువు:weight, బ్యాగులు:bags, ధర:price });
    await item.save();
    res.json(item);
});

// Get Items by Admin
app.get("/items/:adminId", async (req,res)=>{
    const items = await Item.find({ adminId: req.params.adminId });
    res.json(items);
});

// Get Customers of Admin
app.get("/customers/:adminId", async (req,res)=>{
    const admin = await Admin.findById(req.params.adminId).populate("customerIds");
    res.json(admin.customerIds);
});

// Get Shops for Customer
app.get("/myShops/:userId", async (req,res)=>{
    const admins = await Admin.find({ customerIds: req.params.userId });
    res.json(admins);
});

// Start server
const PORT = process.env.PORT || 5000;
app.listen(PORT, ()=>console.log(`Server running on port ${PORT}`));
